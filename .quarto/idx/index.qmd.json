{"title":"Family Planning Clinic Visits","markdown":{"yaml":{"title":"Family Planning Clinic Visits","include-in-header":"www/script.html"},"headingText":"Overview","containsRefs":false,"markdown":"\n\n```{r, Data Inputs}\n\nlibrary(tidyverse)\nlibrary(tidycensus)\nlibrary(sf)\nlibrary(readxl)\nlibrary(rio)\nlibrary(tidyr)\nlibrary(highcharter)\nlibrary(leaflet)\nlibrary(reshape2)\nlibrary(lubridate)\nlibrary(purrr)\nlibrary(readr)\nlibrary(cpaltemplates)\nlibrary(DT)\n\nlibDB <- \"/Users/Michael/CPAL Dropbox\"\nparklandDir <- \"/Maternal Health/02_Data/Parkland Family Planning/reexternalreparklanddatareport\"\nparklandFiles <- list.files(path = paste0(libDB, parklandDir), pattern = \"*.xls\", full.names = TRUE)\n\nage<-read_csv('data/age.csv', show_col_types = FALSE)\nrace<-read_csv('data/race.csv', show_col_types = FALSE)\nzip<-read_csv('data/zip.csv', show_col_types = FALSE)\npayor<-read_csv('data/payor.csv', show_col_types = FALSE)\nmethod<-read_csv('data/method.csv', show_col_types = FALSE)\ntitleX<-read_csv('data/titleX.csv', show_col_types = FALSE)\nlarc<-read_csv('data/larc.csv', show_col_types = FALSE)\n\n```\nThe Child Poverty Action Lab receives a roll-up of family planning related visits to Parkland Health Clinics across Dallas County quarterly. All visualizations across this report contain summarizes for the most recent complete calendar year where applicable.\n\n**Last Updated:** `r format(today(), \"%B %d, %Y\")`\n\n\n```{r, Table Summary by Year}\nage<-age%>%filter(age!='Total')%>%\n  group_by(age, quarter)%>%\n  summarise(total=sum(total))%>%\n  mutate(catTotal=sum(total), percent=round(total/catTotal*100, 2))\n\nteensCount <- age %>%\n                 filter(age %in% c('15-17', '18-19')) %>% \n                 pull(total) %>% \n                 sum()\n\noverview<-data.frame(Year='2023', \n            `Total Clinic Visits` = scales::number(sum(age$total), big.mark=','), \n            LARC = scales::number(nrow(larc), big.mark=','), \n            Teens = scales::number(teensCount, big.mark=',')\n            )\n\ndatatable(overview, options = list(paging = FALSE,\n                           searching = FALSE,\n                           info = FALSE\n                           ),\n            rownames = FALSE) %>%\n  formatStyle(columns = colnames(.), fontWeight = 'bold', `text-align` = 'left') %>%\n  formatStyle(columns = colnames(.), fontFamily = \"Poppins\")\n\n```\n\n## Patient Demographics\n\n```{r, Bar Chart by Age Group}\n\nage<-age %>% mutate(age = factor(age, levels = c(\"Under 15\", \"15-17\", \"18-19\", \"20-24\", '25-29', '30-34', '35-39', '40-44', 'Over 44')))\n\nage<-age[order(age$age),]\n\nageChart <- highchart() %>%\n  hc_xAxis(categories = unique(age$age)) %>%\n  hc_yAxis(reversedStacks=FALSE) %>%\n  hc_add_series(data = age, type = \"bar\", hcaes(x = age, y = total, group = quarter)) %>%\n  hc_chart(type = \"bar\") %>%\n  hc_plotOptions(bar = list(stacking = \"normal\"))%>%\n  hc_tooltip(formatter = JS(\"function() {\n      let age = this.point.age;\n      let count = this.point.y.toLocaleString();\n      let percent = this.point.percent.toFixed(1) + '%'; \n\n      return '<b>Age Group: </b>' + age + '<br>' +\n             '<b>Count: </b>' + count + '<br>' + \n             '<b>Percent: </b>' + percent;\n  }\")) %>%\n  hc_colors(palette_cpal_main)%>%\n  hc_title(text='Family Planning Clinic Visits by Age Group')\n\nageChart\n```\n\n```{r, Demographics Bar Chart}\n#| include: FALSE\nraceCopy<- race %>%\n  group_by(date) %>%\n  summarise(non_hispanic=sum(hispanic), race='Hispanic')\n\nrace<-race %>% \n  select(-hispanic, -undup_totals) %>%\n  bind_rows(raceCopy) %>%\n  mutate(race = case_when(race %in% c(\"American Indian\", \"Pacific Islander\", \"Mixed\", \"Pacific Islander\", \"Unknown\", \"Unknown/Not Reported\", \"More than one Race\") ~ \"Additional Groups\",\n                          TRUE ~ race)) %>%\n  group_by(race) %>%\n  summarise(total=sum(non_hispanic)) %>%\n  mutate(percent=round(total/sum(total)*100,2)) %>%\n  filter(race!='Total')\n\norder<-c('Hispanic', 'Black', 'White','Asian' ,'Additional Groups')\n\nrace$race <- factor(race$race, levels = order) \n\nrace <- race %>% arrange(race) \n\nraceChart<- highchart() %>%\n  hc_chart(type='bar') %>%\n  hc_xAxis(categories=race$race) %>%\n  hc_add_series(data=race$percent, tooltip = list(\n    headerFormat = '',  \n    pointFormat = '<b>{point.category}:</b> {point.y:.1f}%' \n  ),showInLegend=FALSE) %>%\n  hc_colors(palette_cpal_main) %>%\n  hc_title(text='Family Planning Clinic Visits by Race/Ethnicity') %>%\n  hc_yAxis(labels = list(\n    formatter = JS(\"function() { return this.value + '%'; }\") \n  ), max = 100) %>%\n  hc_plotOptions(series = list(\n    groupPadding = 0.1,   # Reduce space between groups (adjust as needed)\n    pointPadding = 0.05   # Reduce space within groups (adjust as needed)\n  ))  \n\nraceChart\n```\n\n```{r, Demographics Pie Chart, fig.height=4}\norder<-c('Additional Groups', 'Asian', 'Black','Hispanic' ,'White')\nrace$race <- factor(race$race, levels = order) \nrace <- race %>% arrange(race)\nracePieChart<-race%>%\n  hchart('pie', hcaes(x=race, y= percent), name = 'Percent')%>%\n  hc_title(text = \"Race Distribution (Total Records: 3508)\") %>%\n  hc_legend(align = \"right\", layout = \"vertical\", verticalAlign = \"middle\") %>%\n  hc_plotOptions(pie = list(\n    showInLegend = TRUE,\n    dataLabels = list(enabled = FALSE)\n  ))%>%\n  hc_colors(palette_cpal_main) \nracePieChart\n```\n\n```{r, Zip Code Data Gather}\n#| include: FALSE\n\nzip<-zip %>% \n  group_by(zip_code, year) %>%\n  summarize(clients = sum(clients, na.rm = TRUE)) %>%\n  ungroup() %>%\n  filter(year == year(today()-years(1))) %>%\n  rename(GEOID = zip_code)\n\nvar <- c(\"tot_wmn\" = \"B01001_026\")\n\ncounties <- tigris::counties(state = \"TX\")\n\ndallas <- counties %>%\n  filter(GEOID == \"48113\")\n\nzctaEst <- get_acs(geography = \"zcta\",\n                  year = 2022,\n                  variables = var,\n                  output = \"wide\") %>%\n  left_join(., zip) %>%\n  mutate(visitsCap = round(signif((clients/tot_wmnE)*10000, digits =1), 0))\n\nzctaSf <- tigris::zctas(state = \"TX\",\n                        year = 2010) %>%\n  transmute(GEOID = ZCTA5CE10,\n            geometry = geometry) %>%\n  left_join(., zctaEst) %>%\n  filter(!is.na(year)) %>%\n  .[dallas, ]\n\n# Calculate Jenks natural breaks\njenks_breaks <- classInt::classIntervals(zctaSf$visitsCap, n = 5, style = \"jenks\")\n\n# Get the breaks to use in the color palette\nbreaks <- signif(jenks_breaks$brks, digits = 1)\n\n# create color palette \ncolor_palette <- colorBin(palette = palette_cpal_magenta, domain = zctaSf$visitsCap, bins = breaks, na.color = \"transparent\")\n\n```\n\n##### Total Clinic Visits Per Capita in Dallas County Zip Codes\n\n```{r, Zip Code Map of Visits}\n# Create Leaflet map\nzipChart<-leaflet(data = zctaSf) %>%\n  addTiles(urlTemplate = cpaltemplates::cpal_mapbox_color) %>%  \n  addPolygons(\n    fillColor = ~color_palette(visitsCap),\n    color = \"#BDBDC3\",\n    weight = 1,\n    opacity = 1,\n    fillOpacity = 0.8,\n    popup = ~paste(\"Visits per Cap: \", visitsCap)\n  ) %>%\n  addLegend(pal = color_palette, values = ~visitsCap, opacity = 0.7,\n            title = \"Visits per Cap\",\n            position = \"bottomright\")\n\nzipChart\n\n```\n\n## Method and Payor Insights\n\n```{r, Method Heatmap}\nmethod<-method[method$method!='Totals',]\n\nmethod<-method%>%\n  mutate(category=case_when(method %in% c('CERVICAL CAP','DIAPHRAGM', 'FEMALE CONDOM', 'MALE CONDOM', 'SPERMICIDE', 'SPONGE')~ 'Barrier Methods',\n            method %in% c('DEPO PRO', 'LUNELLE')~'Injections',\n            method %in% c('ABSTINENCE', 'FAM')~ 'Behavioral Methods',\n            method %in% c('HORMONAL PATCH', 'ORALS', 'VAGINAL RING')~'Scheduled Hormonal Methods',\n            method %in% c('NONE', 'OTHER')~'Other/None',\n            method %in% c('HORMONE IMPLANT','IUD')~'Hormonal Implants',\n            method %in% c('STERILIZATION')~'Sterilization',\n         TRUE ~ method),\n         ageCategory = factor(ageCategory, levels = c(\"Under 15\", \"15-17\", \"18-19\", \"20-24\", '25-29', '30-34', '35-39', '40-44', '45+')))%>%\n   group_by(method, category, ageCategory) %>% \n  summarise(value=sum(value))\n\nMethodHeathc<-highchart() %>%\n  hc_add_series(\n    data = method,\n    type = \"heatmap\",\n    hcaes(x = method, y = ageCategory, value=value),\n    borderWidth = 1,\n    nullColor = '#EFEFEF'  \n  ) %>%\n  hc_xAxis(categories = unique(method$method)) %>%\n  hc_yAxis(categories = unique(method$ageCategory), reversed = TRUE) %>%\n  hc_colorAxis(min = 0, max = 600,\n               minColor = palette_cpal_magenta[1], \n               maxColor = palette_cpal_magenta[8],\n               stops = color_stops(3, palette_cpal_magenta)\n               )%>% \n  hc_title(text='Reported Contraceptive Methods by Age Group')%>%\n  hc_tooltip(formatter = JS(\"function() {\n      let category = this.point.category;\n      let value = this.point.value.toLocaleString();\n      let method = this.point.method;\n      let ageCategory = this.point.ageCategory;\n\n      return '<b>Contraceptive Type: </b>' + category + '<br>' +\n             '<b>Count: </b>' + value + '<br>' + \n             '<b>Method: </b>' + method+ '<br>' + \n             '<b>Age: </b>' + ageCategory;\n  }\")) \nMethodHeathc\n```\n\n:::{.callout-note}\nPlease note that all payer types listed in the following charts are rolled up from the original data into 6 distinct sub-groups. Any payor type that includes the word `Medicaid` is listed under the `Medicaid` sub-group and Family Planning programs related to specific clinics such as `Molina`, `Amerigroup`, or `Wellpoint` are listed under `General Family Planning`.\n:::\n\n```{r, Payor Types All Visits Pie Chart, fig.height=4}\n\npayor<-payor %>%\n  filter(payor!='Total') %>%\n  mutate(payorTypes = ifelse(str_detect(payor, \"Healthy Tx Women\"), \"Healthy Texas Women\",\n                        ifelse(str_detect(payor, \"Medicaid\"), \"Medicaid\", \n                               ifelse(str_detect(payor, \"Parkland Community Health\"), \"Parkland Community Health Plan\",\n                                      ifelse(str_detect(payor, \"Family Planning Program\"), \"Family Planning Program\", \n                                             ifelse(str_detect(payor, \"Amerigroup\"), \"General Family Planning\",\n                                                    ifelse(str_detect(payor, \"Molina\"), \"General Family Planning\",\n                                                           ifelse(str_detect(payor, \"Wellpoint\"), \"General Family Planning\",\n                                                    payor\n                                      \n                                      ))))))))\n\npayorPie<-payor%>%group_by(payorTypes)%>% summarise(value=sum(value))%>% mutate(percent = round(value/sum(value)*100, 2))\n\npayorPieChart<-highchart() %>%\n  hc_chart(type = \"pie\") %>% \n  hc_add_series(\n    data = payorPie,\n    hcaes(x = payorTypes, y = percent), \n    name = 'Percent',\n    type = \"pie\",\n    dataLabels = list(enabled = FALSE),\n    showInLegend=TRUE\n  ) %>%\n  hc_legend(align = \"right\",\n            layout = \"vertical\",\n            verticalAlign = \"middle\")%>%\n  hc_colors(palette_cpal_main)%>%\n  hc_title(text='Payors for Family Planning Clinic Visits')\n\npayorPieChart\n\n```\n\n```{r, Total Payers Over Time by Month}\n\npayor<-payor%>%group_by(newDate, payorTypes)%>%summarise(value=sum(value))\npayorChart<- highchart()%>%\n  hc_add_series(data = payor, type = 'area', hcaes(x = payorTypes, y = value, group = payorTypes))%>%\n  hc_xAxis(categories = unique(payor$newDate))%>%\n  hc_colors(palette_cpal_main)%>%\n  hc_title(text='Payors for Clinic Visits Over Time')\npayorChart\n```\n\n## LARC Insights\n\n:::{.callout-note}\nThe following charts contain summaries for all patients who received a LARC after birth at a Parkland Health Clinic. \n:::\n\n```{r, Title X Line Chart for LARC}\ntitleX<-titleX%>%group_by(title_x, newDate)%>%summarise(value=sum(value))%>%filter(title_x=='Total')\ntitleXchart<-hchart(titleX, \"line\", hcaes(x = newDate, y = value, group = title_x)) %>%\n  hc_xAxis(type='datetime', title=NULL) %>% \n  hc_yAxis(title = 'Visits', min =0)%>%\n  hc_colors(palette_cpal_main) %>%\n  hc_title(text='Title X Family Planning Visits Receiving LARC')\ntitleXchart\n```\n\n```{r, Payors LARC Pie Chart, fig.height=4}\nlarcByPayor<-larc%>%group_by(payor) %>% summarise(n=n())%>% \n  mutate(percent = round(n/sum(n)*100, 2),\n         payor = case_when(payor %in% c('Managed Care', 'Managed Care ACA', 'Medicare Managed Care', 'Medicaid Managed Care', 'Medicaid (traditional)')~ 'Managed Care', \n         TRUE ~ payor))%>% group_by(payor)%>%summarise(percent=sum(percent))\nlarcPayorChart <-larcByPayor%>%hchart('pie', hcaes(x=payor, y= percent), name = 'Payor')%>%\n  hc_legend(align = \"right\", layout = \"vertical\", verticalAlign = \"middle\") %>%\n  hc_plotOptions(pie = list(\n    showInLegend = TRUE,\n    dataLabels = list(enabled = FALSE)\n  ))%>%\n  hc_colors(palette_cpal_main)%>%\n  hc_title(text='Distribution of Payors for LARCs')\nlarcPayorChart\n```\n\n```{r, Race/Ethnicity LARC Pie Chart, fig.height=4}\nlarcCopy <- larc %>% mutate(hispanic = ifelse(ethnicity %in% c(\"Hispanic\", \"Latino\"), 1, 0),\n                                         non_hispanic = ifelse(ethnicity %in% c(\"Hispanic\", \"Latino\"), 0, 1))\nlarcHispanic<-larcCopy%>%summarise(total=sum(hispanic), race = 'Hispanic')\nlarcByRace<-larcCopy%>%group_by(race)%>%summarise(total=sum(non_hispanic))%>% bind_rows(larcHispanic)%>%\n  mutate(race =ifelse(race %in% c(\"Am Indian\", \"Pac Islander\", 'Pacific Islander', 'Unknown'), \"Additonal Groups\", race))%>%\n  group_by(race)%>%summarise(total=sum(total))%>%mutate(percent=round(total/sum(total)*100, 2))\n\nlarcByRaceChart<-larcByRace%>%hchart('pie', hcaes(x=race, y= percent), name = 'Percent')%>%\n  hc_title(text = \"LARC by Race Distribution\") %>%\n  hc_legend(align = \"right\", layout = \"vertical\", verticalAlign = \"middle\") %>%\n  hc_plotOptions(pie = list(\n    showInLegend = TRUE,\n    dataLabels = list(enabled = FALSE)\n  ))%>%\n  hc_colors(palette_cpal_main) \nlarcByRaceChart\n```\n\n\n\n\n","srcMarkdownNoYaml":"\n\n```{r, Data Inputs}\n\nlibrary(tidyverse)\nlibrary(tidycensus)\nlibrary(sf)\nlibrary(readxl)\nlibrary(rio)\nlibrary(tidyr)\nlibrary(highcharter)\nlibrary(leaflet)\nlibrary(reshape2)\nlibrary(lubridate)\nlibrary(purrr)\nlibrary(readr)\nlibrary(cpaltemplates)\nlibrary(DT)\n\nlibDB <- \"/Users/Michael/CPAL Dropbox\"\nparklandDir <- \"/Maternal Health/02_Data/Parkland Family Planning/reexternalreparklanddatareport\"\nparklandFiles <- list.files(path = paste0(libDB, parklandDir), pattern = \"*.xls\", full.names = TRUE)\n\nage<-read_csv('data/age.csv', show_col_types = FALSE)\nrace<-read_csv('data/race.csv', show_col_types = FALSE)\nzip<-read_csv('data/zip.csv', show_col_types = FALSE)\npayor<-read_csv('data/payor.csv', show_col_types = FALSE)\nmethod<-read_csv('data/method.csv', show_col_types = FALSE)\ntitleX<-read_csv('data/titleX.csv', show_col_types = FALSE)\nlarc<-read_csv('data/larc.csv', show_col_types = FALSE)\n\n```\nThe Child Poverty Action Lab receives a roll-up of family planning related visits to Parkland Health Clinics across Dallas County quarterly. All visualizations across this report contain summarizes for the most recent complete calendar year where applicable.\n\n**Last Updated:** `r format(today(), \"%B %d, %Y\")`\n\n## Overview\n\n```{r, Table Summary by Year}\nage<-age%>%filter(age!='Total')%>%\n  group_by(age, quarter)%>%\n  summarise(total=sum(total))%>%\n  mutate(catTotal=sum(total), percent=round(total/catTotal*100, 2))\n\nteensCount <- age %>%\n                 filter(age %in% c('15-17', '18-19')) %>% \n                 pull(total) %>% \n                 sum()\n\noverview<-data.frame(Year='2023', \n            `Total Clinic Visits` = scales::number(sum(age$total), big.mark=','), \n            LARC = scales::number(nrow(larc), big.mark=','), \n            Teens = scales::number(teensCount, big.mark=',')\n            )\n\ndatatable(overview, options = list(paging = FALSE,\n                           searching = FALSE,\n                           info = FALSE\n                           ),\n            rownames = FALSE) %>%\n  formatStyle(columns = colnames(.), fontWeight = 'bold', `text-align` = 'left') %>%\n  formatStyle(columns = colnames(.), fontFamily = \"Poppins\")\n\n```\n\n## Patient Demographics\n\n```{r, Bar Chart by Age Group}\n\nage<-age %>% mutate(age = factor(age, levels = c(\"Under 15\", \"15-17\", \"18-19\", \"20-24\", '25-29', '30-34', '35-39', '40-44', 'Over 44')))\n\nage<-age[order(age$age),]\n\nageChart <- highchart() %>%\n  hc_xAxis(categories = unique(age$age)) %>%\n  hc_yAxis(reversedStacks=FALSE) %>%\n  hc_add_series(data = age, type = \"bar\", hcaes(x = age, y = total, group = quarter)) %>%\n  hc_chart(type = \"bar\") %>%\n  hc_plotOptions(bar = list(stacking = \"normal\"))%>%\n  hc_tooltip(formatter = JS(\"function() {\n      let age = this.point.age;\n      let count = this.point.y.toLocaleString();\n      let percent = this.point.percent.toFixed(1) + '%'; \n\n      return '<b>Age Group: </b>' + age + '<br>' +\n             '<b>Count: </b>' + count + '<br>' + \n             '<b>Percent: </b>' + percent;\n  }\")) %>%\n  hc_colors(palette_cpal_main)%>%\n  hc_title(text='Family Planning Clinic Visits by Age Group')\n\nageChart\n```\n\n```{r, Demographics Bar Chart}\n#| include: FALSE\nraceCopy<- race %>%\n  group_by(date) %>%\n  summarise(non_hispanic=sum(hispanic), race='Hispanic')\n\nrace<-race %>% \n  select(-hispanic, -undup_totals) %>%\n  bind_rows(raceCopy) %>%\n  mutate(race = case_when(race %in% c(\"American Indian\", \"Pacific Islander\", \"Mixed\", \"Pacific Islander\", \"Unknown\", \"Unknown/Not Reported\", \"More than one Race\") ~ \"Additional Groups\",\n                          TRUE ~ race)) %>%\n  group_by(race) %>%\n  summarise(total=sum(non_hispanic)) %>%\n  mutate(percent=round(total/sum(total)*100,2)) %>%\n  filter(race!='Total')\n\norder<-c('Hispanic', 'Black', 'White','Asian' ,'Additional Groups')\n\nrace$race <- factor(race$race, levels = order) \n\nrace <- race %>% arrange(race) \n\nraceChart<- highchart() %>%\n  hc_chart(type='bar') %>%\n  hc_xAxis(categories=race$race) %>%\n  hc_add_series(data=race$percent, tooltip = list(\n    headerFormat = '',  \n    pointFormat = '<b>{point.category}:</b> {point.y:.1f}%' \n  ),showInLegend=FALSE) %>%\n  hc_colors(palette_cpal_main) %>%\n  hc_title(text='Family Planning Clinic Visits by Race/Ethnicity') %>%\n  hc_yAxis(labels = list(\n    formatter = JS(\"function() { return this.value + '%'; }\") \n  ), max = 100) %>%\n  hc_plotOptions(series = list(\n    groupPadding = 0.1,   # Reduce space between groups (adjust as needed)\n    pointPadding = 0.05   # Reduce space within groups (adjust as needed)\n  ))  \n\nraceChart\n```\n\n```{r, Demographics Pie Chart, fig.height=4}\norder<-c('Additional Groups', 'Asian', 'Black','Hispanic' ,'White')\nrace$race <- factor(race$race, levels = order) \nrace <- race %>% arrange(race)\nracePieChart<-race%>%\n  hchart('pie', hcaes(x=race, y= percent), name = 'Percent')%>%\n  hc_title(text = \"Race Distribution (Total Records: 3508)\") %>%\n  hc_legend(align = \"right\", layout = \"vertical\", verticalAlign = \"middle\") %>%\n  hc_plotOptions(pie = list(\n    showInLegend = TRUE,\n    dataLabels = list(enabled = FALSE)\n  ))%>%\n  hc_colors(palette_cpal_main) \nracePieChart\n```\n\n```{r, Zip Code Data Gather}\n#| include: FALSE\n\nzip<-zip %>% \n  group_by(zip_code, year) %>%\n  summarize(clients = sum(clients, na.rm = TRUE)) %>%\n  ungroup() %>%\n  filter(year == year(today()-years(1))) %>%\n  rename(GEOID = zip_code)\n\nvar <- c(\"tot_wmn\" = \"B01001_026\")\n\ncounties <- tigris::counties(state = \"TX\")\n\ndallas <- counties %>%\n  filter(GEOID == \"48113\")\n\nzctaEst <- get_acs(geography = \"zcta\",\n                  year = 2022,\n                  variables = var,\n                  output = \"wide\") %>%\n  left_join(., zip) %>%\n  mutate(visitsCap = round(signif((clients/tot_wmnE)*10000, digits =1), 0))\n\nzctaSf <- tigris::zctas(state = \"TX\",\n                        year = 2010) %>%\n  transmute(GEOID = ZCTA5CE10,\n            geometry = geometry) %>%\n  left_join(., zctaEst) %>%\n  filter(!is.na(year)) %>%\n  .[dallas, ]\n\n# Calculate Jenks natural breaks\njenks_breaks <- classInt::classIntervals(zctaSf$visitsCap, n = 5, style = \"jenks\")\n\n# Get the breaks to use in the color palette\nbreaks <- signif(jenks_breaks$brks, digits = 1)\n\n# create color palette \ncolor_palette <- colorBin(palette = palette_cpal_magenta, domain = zctaSf$visitsCap, bins = breaks, na.color = \"transparent\")\n\n```\n\n##### Total Clinic Visits Per Capita in Dallas County Zip Codes\n\n```{r, Zip Code Map of Visits}\n# Create Leaflet map\nzipChart<-leaflet(data = zctaSf) %>%\n  addTiles(urlTemplate = cpaltemplates::cpal_mapbox_color) %>%  \n  addPolygons(\n    fillColor = ~color_palette(visitsCap),\n    color = \"#BDBDC3\",\n    weight = 1,\n    opacity = 1,\n    fillOpacity = 0.8,\n    popup = ~paste(\"Visits per Cap: \", visitsCap)\n  ) %>%\n  addLegend(pal = color_palette, values = ~visitsCap, opacity = 0.7,\n            title = \"Visits per Cap\",\n            position = \"bottomright\")\n\nzipChart\n\n```\n\n## Method and Payor Insights\n\n```{r, Method Heatmap}\nmethod<-method[method$method!='Totals',]\n\nmethod<-method%>%\n  mutate(category=case_when(method %in% c('CERVICAL CAP','DIAPHRAGM', 'FEMALE CONDOM', 'MALE CONDOM', 'SPERMICIDE', 'SPONGE')~ 'Barrier Methods',\n            method %in% c('DEPO PRO', 'LUNELLE')~'Injections',\n            method %in% c('ABSTINENCE', 'FAM')~ 'Behavioral Methods',\n            method %in% c('HORMONAL PATCH', 'ORALS', 'VAGINAL RING')~'Scheduled Hormonal Methods',\n            method %in% c('NONE', 'OTHER')~'Other/None',\n            method %in% c('HORMONE IMPLANT','IUD')~'Hormonal Implants',\n            method %in% c('STERILIZATION')~'Sterilization',\n         TRUE ~ method),\n         ageCategory = factor(ageCategory, levels = c(\"Under 15\", \"15-17\", \"18-19\", \"20-24\", '25-29', '30-34', '35-39', '40-44', '45+')))%>%\n   group_by(method, category, ageCategory) %>% \n  summarise(value=sum(value))\n\nMethodHeathc<-highchart() %>%\n  hc_add_series(\n    data = method,\n    type = \"heatmap\",\n    hcaes(x = method, y = ageCategory, value=value),\n    borderWidth = 1,\n    nullColor = '#EFEFEF'  \n  ) %>%\n  hc_xAxis(categories = unique(method$method)) %>%\n  hc_yAxis(categories = unique(method$ageCategory), reversed = TRUE) %>%\n  hc_colorAxis(min = 0, max = 600,\n               minColor = palette_cpal_magenta[1], \n               maxColor = palette_cpal_magenta[8],\n               stops = color_stops(3, palette_cpal_magenta)\n               )%>% \n  hc_title(text='Reported Contraceptive Methods by Age Group')%>%\n  hc_tooltip(formatter = JS(\"function() {\n      let category = this.point.category;\n      let value = this.point.value.toLocaleString();\n      let method = this.point.method;\n      let ageCategory = this.point.ageCategory;\n\n      return '<b>Contraceptive Type: </b>' + category + '<br>' +\n             '<b>Count: </b>' + value + '<br>' + \n             '<b>Method: </b>' + method+ '<br>' + \n             '<b>Age: </b>' + ageCategory;\n  }\")) \nMethodHeathc\n```\n\n:::{.callout-note}\nPlease note that all payer types listed in the following charts are rolled up from the original data into 6 distinct sub-groups. Any payor type that includes the word `Medicaid` is listed under the `Medicaid` sub-group and Family Planning programs related to specific clinics such as `Molina`, `Amerigroup`, or `Wellpoint` are listed under `General Family Planning`.\n:::\n\n```{r, Payor Types All Visits Pie Chart, fig.height=4}\n\npayor<-payor %>%\n  filter(payor!='Total') %>%\n  mutate(payorTypes = ifelse(str_detect(payor, \"Healthy Tx Women\"), \"Healthy Texas Women\",\n                        ifelse(str_detect(payor, \"Medicaid\"), \"Medicaid\", \n                               ifelse(str_detect(payor, \"Parkland Community Health\"), \"Parkland Community Health Plan\",\n                                      ifelse(str_detect(payor, \"Family Planning Program\"), \"Family Planning Program\", \n                                             ifelse(str_detect(payor, \"Amerigroup\"), \"General Family Planning\",\n                                                    ifelse(str_detect(payor, \"Molina\"), \"General Family Planning\",\n                                                           ifelse(str_detect(payor, \"Wellpoint\"), \"General Family Planning\",\n                                                    payor\n                                      \n                                      ))))))))\n\npayorPie<-payor%>%group_by(payorTypes)%>% summarise(value=sum(value))%>% mutate(percent = round(value/sum(value)*100, 2))\n\npayorPieChart<-highchart() %>%\n  hc_chart(type = \"pie\") %>% \n  hc_add_series(\n    data = payorPie,\n    hcaes(x = payorTypes, y = percent), \n    name = 'Percent',\n    type = \"pie\",\n    dataLabels = list(enabled = FALSE),\n    showInLegend=TRUE\n  ) %>%\n  hc_legend(align = \"right\",\n            layout = \"vertical\",\n            verticalAlign = \"middle\")%>%\n  hc_colors(palette_cpal_main)%>%\n  hc_title(text='Payors for Family Planning Clinic Visits')\n\npayorPieChart\n\n```\n\n```{r, Total Payers Over Time by Month}\n\npayor<-payor%>%group_by(newDate, payorTypes)%>%summarise(value=sum(value))\npayorChart<- highchart()%>%\n  hc_add_series(data = payor, type = 'area', hcaes(x = payorTypes, y = value, group = payorTypes))%>%\n  hc_xAxis(categories = unique(payor$newDate))%>%\n  hc_colors(palette_cpal_main)%>%\n  hc_title(text='Payors for Clinic Visits Over Time')\npayorChart\n```\n\n## LARC Insights\n\n:::{.callout-note}\nThe following charts contain summaries for all patients who received a LARC after birth at a Parkland Health Clinic. \n:::\n\n```{r, Title X Line Chart for LARC}\ntitleX<-titleX%>%group_by(title_x, newDate)%>%summarise(value=sum(value))%>%filter(title_x=='Total')\ntitleXchart<-hchart(titleX, \"line\", hcaes(x = newDate, y = value, group = title_x)) %>%\n  hc_xAxis(type='datetime', title=NULL) %>% \n  hc_yAxis(title = 'Visits', min =0)%>%\n  hc_colors(palette_cpal_main) %>%\n  hc_title(text='Title X Family Planning Visits Receiving LARC')\ntitleXchart\n```\n\n```{r, Payors LARC Pie Chart, fig.height=4}\nlarcByPayor<-larc%>%group_by(payor) %>% summarise(n=n())%>% \n  mutate(percent = round(n/sum(n)*100, 2),\n         payor = case_when(payor %in% c('Managed Care', 'Managed Care ACA', 'Medicare Managed Care', 'Medicaid Managed Care', 'Medicaid (traditional)')~ 'Managed Care', \n         TRUE ~ payor))%>% group_by(payor)%>%summarise(percent=sum(percent))\nlarcPayorChart <-larcByPayor%>%hchart('pie', hcaes(x=payor, y= percent), name = 'Payor')%>%\n  hc_legend(align = \"right\", layout = \"vertical\", verticalAlign = \"middle\") %>%\n  hc_plotOptions(pie = list(\n    showInLegend = TRUE,\n    dataLabels = list(enabled = FALSE)\n  ))%>%\n  hc_colors(palette_cpal_main)%>%\n  hc_title(text='Distribution of Payors for LARCs')\nlarcPayorChart\n```\n\n```{r, Race/Ethnicity LARC Pie Chart, fig.height=4}\nlarcCopy <- larc %>% mutate(hispanic = ifelse(ethnicity %in% c(\"Hispanic\", \"Latino\"), 1, 0),\n                                         non_hispanic = ifelse(ethnicity %in% c(\"Hispanic\", \"Latino\"), 0, 1))\nlarcHispanic<-larcCopy%>%summarise(total=sum(hispanic), race = 'Hispanic')\nlarcByRace<-larcCopy%>%group_by(race)%>%summarise(total=sum(non_hispanic))%>% bind_rows(larcHispanic)%>%\n  mutate(race =ifelse(race %in% c(\"Am Indian\", \"Pac Islander\", 'Pacific Islander', 'Unknown'), \"Additonal Groups\", race))%>%\n  group_by(race)%>%summarise(total=sum(total))%>%mutate(percent=round(total/sum(total)*100, 2))\n\nlarcByRaceChart<-larcByRace%>%hchart('pie', hcaes(x=race, y= percent), name = 'Percent')%>%\n  hc_title(text = \"LARC by Race Distribution\") %>%\n  hc_legend(align = \"right\", layout = \"vertical\", verticalAlign = \"middle\") %>%\n  hc_plotOptions(pie = list(\n    showInLegend = TRUE,\n    dataLabels = list(enabled = FALSE)\n  ))%>%\n  hc_colors(palette_cpal_main) \nlarcByRaceChart\n```\n\n\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":9,"fig-height":7,"fig-format":"retina","fig-dpi":300,"df-print":"default","error":true,"eval":true,"cache":null,"freeze":false,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":2,"include-in-header":["www/script.html"],"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.549","theme":"www/web_report.scss","toc-title":"Contents","toc-location":"right","anchor-sections":false,"code-summary":"Reveal Code","code-copy":"hover","smooth-scroll":true,"grid":{"sidebar-width":"250px","body-width":"900px","margin-width":"300px"},"code-block-bg":true,"code-block-border-left":"#008097","message":false,"title":"Family Planning Clinic Visits"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}